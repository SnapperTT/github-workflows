name: Discord Commit Notification

on:
  workflow_call:
    inputs:
      commit_msg:
        required: true
        type: string
      branch:
        required: true
        type: string
      sha:
        required: true
        type: string
      author:
        required: true
        type: string
      repo:
        required: true
        type: string
      is_private:
        required: true
        type: boolean
      stats_summary:
        required: true
        type: string
    secrets:
      DISCORD_WEBHOOK:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send commit to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MSG="${{ inputs.commit_msg }}"
          USERNAME="${{ inputs.author }}"
          SHORT_SHA="${{ inputs.sha::7 }}"
          BRANCH="${{ inputs.branch }}"
          REPO="${{ inputs.repo }}"
          IS_PRIVATE="${{ inputs.is_private }}"
          STATS="${{ inputs.stats_summary }}"

          # Replace specific username if desired
          if [ "$USERNAME" = "SnapperTT" ]; then
            USERNAME="SnapperTheTwig"
          fi

          # Repo display: link if public
          if [ "$IS_PRIVATE" = "true" ]; then
            REPO_DISPLAY="$REPO"
          else
            REPO_DISPLAY="[$REPO](https://github.com/$REPO)"
          fi

          # Build Discord payload
          jq -n \
            --arg branch "$BRANCH" \
            --arg sha "$SHORT_SHA" \
            --arg author "$USERNAME" \
            --arg msg "$COMMIT_MSG" \
            --arg repo "$REPO_DISPLAY" \
            --arg summary "$STATS" \
            '{
              embeds: [{
                title: ("New Commit on " + $branch),
                description: ("```" + $msg + "```"),
                color: 5814783,
                fields: [
                  { name: "Commit", value: $sha, inline: true },
                  { name: "Author", value: $author, inline: true },
                  { name: "Repo", value: $repo, inline: true },
                  { name: "Changes", value: $summary, inline: false }
                ]
              }]
            }' > payload.json

          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d @payload.json \
               "$DISCORD_WEBHOOK"
